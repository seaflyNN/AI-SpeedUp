<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenCV WASM Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #output {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>OpenCV WebAssembly Demo</h1>
    <p>è¿™ä¸ªæ¼”ç¤ºå±•ç¤ºäº†å¦‚ä½•åœ¨JavaScriptä¸­è°ƒç”¨å¯¼å‡ºçš„C++å‡½æ•°ã€‚</p>
    
    <button id="testFooBtn" onclick="testFooFunction()" disabled>æµ‹è¯• foo å‡½æ•°</button>
    <button id="testCFooBtn" onclick="testCFooFunction()" disabled>æµ‹è¯• c_foo å‡½æ•°</button>
    <button id="testBarBtn" onclick="testBarFunction()" disabled>æµ‹è¯• bar å‡½æ•°</button>
    <button id="testProcessFileBtn" onclick="testProcessFileFunction()" disabled>æµ‹è¯• processFile å‡½æ•°</button>
    <button id="testAllBtn" onclick="testAllInterfaces()" disabled>æµ‹è¯•æ‰€æœ‰æ¥å£</button>
    <button onclick="clearOutput()">æ¸…ç©ºè¾“å‡º</button>
    
    <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
    <div style="margin: 20px 0; padding: 15px; border: 2px dashed #ccc; border-radius: 8px;">
        <h3>æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h3>
        <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect()" style="margin: 10px 0;">
        <button id="testCProcessFileBtn" onclick="testCProcessFileWithFile()" disabled>ä½¿ç”¨ä¸Šä¼ æ–‡ä»¶æµ‹è¯• c_processFile</button>
        <button id="testWithoutFSBtn" onclick="testWithoutFileSystem()" disabled>æµ‹è¯•å›¾åƒå¤„ç†(ä¸ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿ)</button>
        <button onclick="createSampleImage()">åˆ›å»ºç¤ºä¾‹å›¾åƒ</button>
        <div id="fileInfo" style="margin-top: 10px; font-style: italic; color: #666;"></div>
    </div>
    
    <div id="output"></div>

    <script>
        let Module = null;
        let outputDiv = document.getElementById('output');
        
        function log(message) {
            outputDiv.textContent += message + '\n';
            console.log(message);
        }
        
        function clearOutput() {
            outputDiv.textContent = '';
        }
        
        let currentFile = null;
        
        function enableButtons() {
            document.getElementById('testFooBtn').disabled = false;
            document.getElementById('testCFooBtn').disabled = false;
            document.getElementById('testBarBtn').disabled = false;
            document.getElementById('testProcessFileBtn').disabled = false;
            document.getElementById('testAllBtn').disabled = false;
            updateFileTestButton();
        }
        
        function updateFileTestButton() {
            const processFileBtn = document.getElementById('testCProcessFileBtn');
            const withoutFSBtn = document.getElementById('testWithoutFSBtn');
            
            if (processFileBtn && Module) {
                processFileBtn.disabled = !currentFile;
            }
            
            if (withoutFSBtn && Module) {
                withoutFSBtn.disabled = !currentFile;
            }
        }
        
        function testFooFunction() {
            if (!Module) {
                log('é”™è¯¯: WebAssembly æ¨¡å—å°šæœªåŠ è½½');
                return;
            }
            
            try {
                log('=== æµ‹è¯•ç»‘å®šçš„ foo å‡½æ•° ===');
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ç»‘å®šçš„ foo å‡½æ•°
                if (typeof Module.foo === 'function') {
                    // å…ˆæ£€æŸ¥å†…å­˜ç®¡ç†å‡½æ•°æ˜¯å¦å¯ç”¨
                    if (Module._malloc && Module._free) {
                        // åˆ›å»ºä¸€äº›æµ‹è¯•æ•°æ®
                        const width = 640;
                        const height = 480;
                        const channels = 3;
                        const dataSize = width * height * channels;
                        
                        // åˆ†é…å†…å­˜
                        const dataPtr = Module._malloc(dataSize);
                        
                        if (dataPtr) {
                            // è°ƒç”¨å‡½æ•°
                            Module.foo(dataPtr, width, height, channels);
                            
                            // é‡Šæ”¾å†…å­˜
                            Module._free(dataPtr);
                            
                            log('ç»‘å®šçš„ foo å‡½æ•°è°ƒç”¨æˆåŠŸï¼');
                        } else {
                            log('å†…å­˜åˆ†é…å¤±è´¥');
                        }
                    } else {
                        // å°è¯•ç›´æ¥è°ƒç”¨ï¼ˆä½¿ç”¨0ä½œä¸ºæŒ‡é’ˆï¼‰
                        log('å†…å­˜ç®¡ç†å‡½æ•°ä¸å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨ç©ºæŒ‡é’ˆè°ƒç”¨...');
                        Module.foo(0, 640, 480, 3);
                        log('ç»‘å®šçš„ foo å‡½æ•°è°ƒç”¨æˆåŠŸï¼ˆä½¿ç”¨ç©ºæŒ‡é’ˆï¼‰ï¼');
                    }
                } else {
                    log('ç»‘å®šçš„ foo å‡½æ•°ä¸å¯ç”¨ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºç»‘å®šå¯èƒ½æ²¡æœ‰æ­£ç¡®ç¼–è¯‘');
                }
            } catch (error) {
                log('è°ƒç”¨ç»‘å®šçš„ foo å‡½æ•°æ—¶å‡ºé”™: ' + error.message);
            }
        }
        
        function testCFooFunction() {
            if (!Module) {
                log('é”™è¯¯: WebAssembly æ¨¡å—å°šæœªåŠ è½½');
                return;
            }
            
            try {
                log('=== æµ‹è¯• C é£æ ¼çš„ c_foo å‡½æ•° ===');
                
                // å…ˆæ£€æŸ¥å†…å­˜ç®¡ç†å‡½æ•°
                if (Module._malloc && Module._free) {
                    // ä½¿ç”¨ ccall è°ƒç”¨ C å‡½æ•°
                    const width = 800;
                    const height = 600;
                    const channels = 4;
                    const dataSize = width * height * channels;
                    
                    // åˆ†é…å†…å­˜
                    const dataPtr = Module._malloc(dataSize);
                    
                    if (dataPtr) {
                        // ä½¿ç”¨ ccall è°ƒç”¨å‡½æ•°
                        Module.ccall('c_foo', null, ['number', 'number', 'number', 'number'], 
                                   [dataPtr, width, height, channels]);
                        
                        // é‡Šæ”¾å†…å­˜
                        Module._free(dataPtr);
                        
                        log('C é£æ ¼çš„ c_foo å‡½æ•°è°ƒç”¨æˆåŠŸï¼');
                    } else {
                        log('å†…å­˜åˆ†é…å¤±è´¥');
                    }
                } else {
                    // å°è¯•ä½¿ç”¨ç©ºæŒ‡é’ˆè°ƒç”¨
                    log('å†…å­˜ç®¡ç†å‡½æ•°ä¸å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨ç©ºæŒ‡é’ˆè°ƒç”¨...');
                    Module.ccall('c_foo', null, ['number', 'number', 'number', 'number'], 
                               [0, 800, 600, 4]);
                    log('C é£æ ¼çš„ c_foo å‡½æ•°è°ƒç”¨æˆåŠŸï¼ˆä½¿ç”¨ç©ºæŒ‡é’ˆï¼‰ï¼');
                }
            } catch (error) {
                log('è°ƒç”¨ C é£æ ¼çš„ c_foo å‡½æ•°æ—¶å‡ºé”™: ' + error.message);
                
                // å°è¯•ç›´æ¥è°ƒç”¨å¯¼å‡ºçš„å‡½æ•°
                try {
                    log('å°è¯•ç›´æ¥è°ƒç”¨ _c_foo...');
                    if (Module._malloc && Module._free) {
                        const width = 800;
                        const height = 600;
                        const channels = 4;
                        const dataSize = width * height * channels;
                        const dataPtr = Module._malloc(dataSize);
                        
                        if (dataPtr) {
                            Module._c_foo(dataPtr, width, height, channels);
                            Module._free(dataPtr);
                            log('ç›´æ¥è°ƒç”¨ _c_foo æˆåŠŸï¼');
                        } else {
                            log('å†…å­˜åˆ†é…å¤±è´¥');
                        }
                    } else {
                        // ä½¿ç”¨ç©ºæŒ‡é’ˆ
                        Module._c_foo(0, 800, 600, 4);
                        log('ç›´æ¥è°ƒç”¨ _c_foo æˆåŠŸï¼ˆä½¿ç”¨ç©ºæŒ‡é’ˆï¼‰ï¼');
                    }
                } catch (e) {
                    log('ç›´æ¥è°ƒç”¨ä¹Ÿå¤±è´¥: ' + e.message);
                }
            }
        }
        
        function handleFileSelect() {
            const fileInput = document.getElementById('fileInput');
            const fileInfo = document.getElementById('fileInfo');
            
            if (fileInput.files.length > 0) {
                currentFile = fileInput.files[0];
                fileInfo.textContent = `å·²é€‰æ‹©æ–‡ä»¶: ${currentFile.name} (${currentFile.size} bytes, ${currentFile.type})`;
                log('æ–‡ä»¶å·²é€‰æ‹©: ' + currentFile.name);
                updateFileTestButton();
            } else {
                currentFile = null;
                fileInfo.textContent = '';
                updateFileTestButton();
            }
        }
        
        function createSampleImage() {
            log('=== åˆ›å»ºç¤ºä¾‹å›¾åƒ ===');
            
            try {
                // åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•å›¾åƒ
                const canvas = document.createElement('canvas');
                canvas.width = 200;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                
                // ç»˜åˆ¶å½©è‰²æ–¹å—
                ctx.fillStyle = '#ff0000';
                ctx.fillRect(0, 0, 100, 100);
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(100, 0, 100, 100);
                ctx.fillStyle = '#0000ff';
                ctx.fillRect(0, 100, 100, 100);
                ctx.fillStyle = '#ffff00';
                ctx.fillRect(100, 100, 100, 100);
                
                // è½¬æ¢ä¸ºblobå¹¶åˆ›å»ºæ–‡ä»¶
                canvas.toBlob((blob) => {
                    currentFile = new File([blob], 'sample_image.png', { type: 'image/png' });
                    document.getElementById('fileInfo').textContent = `å·²åˆ›å»ºç¤ºä¾‹å›¾åƒ: ${currentFile.name} (${currentFile.size} bytes)`;
                    log('ç¤ºä¾‹å›¾åƒåˆ›å»ºæˆåŠŸ: ' + currentFile.name);
                    updateFileTestButton();
                }, 'image/png');
                
            } catch (error) {
                log('åˆ›å»ºç¤ºä¾‹å›¾åƒå¤±è´¥: ' + error.message);
            }
        }
        
        function testBarFunction() {
            if (!Module) {
                log('é”™è¯¯: WebAssembly æ¨¡å—å°šæœªåŠ è½½');
                return;
            }
            
            try {
                log('=== æµ‹è¯• bar å‡½æ•° ===');
                
                if (currentFile) {
                    log('ä½¿ç”¨å½“å‰é€‰æ‹©çš„æ–‡ä»¶æµ‹è¯• bar å‡½æ•°...');
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const arrayBuffer = e.target.result;
                        const uint8Array = new Uint8Array(arrayBuffer);
                        
                        // åˆ†é…å†…å­˜
                        const dataPtr = Module._malloc(uint8Array.length);
                        if (dataPtr) {
                            // å¤åˆ¶æ•°æ®åˆ°WASMå†…å­˜
                            Module.HEAPU8.set(uint8Array, dataPtr);
                            
                            // è°ƒç”¨barå‡½æ•°
                            if (Module.bar) {
                                Module.bar(dataPtr, uint8Array.length);
                                log('ç»‘å®šçš„ bar å‡½æ•°è°ƒç”¨æˆåŠŸï¼');
                            } else if (Module._c_bar) {
                                Module._c_bar(dataPtr, uint8Array.length);
                                log('C é£æ ¼çš„ c_bar å‡½æ•°è°ƒç”¨æˆåŠŸï¼');
                            } else {
                                log('bar å‡½æ•°ä¸å¯ç”¨');
                            }
                            
                            // é‡Šæ”¾å†…å­˜
                            Module._free(dataPtr);
                        } else {
                            log('å†…å­˜åˆ†é…å¤±è´¥');
                        }
                    };
                    reader.readAsArrayBuffer(currentFile);
                } else {
                    log('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•...');
                    const testData = new Uint8Array(1000);
                    testData.fill(128); // å¡«å……ç°è‰²å€¼
                    
                    const dataPtr = Module._malloc(testData.length);
                    if (dataPtr) {
                        Module.HEAPU8.set(testData, dataPtr);
                        
                        if (Module.bar) {
                            Module.bar(dataPtr, testData.length);
                            log('ç»‘å®šçš„ bar å‡½æ•°è°ƒç”¨æˆåŠŸï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰ï¼');
                        } else if (Module._c_bar) {
                            Module._c_bar(dataPtr, testData.length);
                            log('C é£æ ¼çš„ c_bar å‡½æ•°è°ƒç”¨æˆåŠŸï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰ï¼');
                        }
                        
                        Module._free(dataPtr);
                    }
                }
            } catch (error) {
                log('æµ‹è¯• bar å‡½æ•°æ—¶å‡ºé”™: ' + error.message);
            }
        }
        
        function testProcessFileFunction() {
            if (!Module) {
                log('é”™è¯¯: WebAssembly æ¨¡å—å°šæœªåŠ è½½');
                return;
            }
            
            try {
                log('=== æµ‹è¯• processFile å‡½æ•° ===');
                
                if (currentFile) {
                    log('ä½¿ç”¨å½“å‰é€‰æ‹©çš„æ–‡ä»¶æµ‹è¯• processFile å‡½æ•°...');
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const arrayBuffer = e.target.result;
                        const uint8Array = new Uint8Array(arrayBuffer);
                        
                        // å†™å…¥è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
                        const filename = '/tmp/' + currentFile.name;
                        Module.FS.writeFile(filename, uint8Array);
                        log('æ–‡ä»¶å·²å†™å…¥è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ: ' + filename);
                        
                        // è°ƒç”¨processFileå‡½æ•°
                        if (Module.processFile) {
                            Module.processFile(filename);
                            log('ç»‘å®šçš„ processFile å‡½æ•°è°ƒç”¨æˆåŠŸï¼');
                        } else if (Module._c_processFile) {
                            Module._c_processFile(filename);
                            log('C é£æ ¼çš„ c_processFile å‡½æ•°è°ƒç”¨æˆåŠŸï¼');
                        } else {
                            log('processFile å‡½æ•°ä¸å¯ç”¨');
                        }
                        
                        // æ£€æŸ¥å¤„ç†åçš„æ–‡ä»¶
                        const processedFilename = filename + '_processed.png';
                        try {
                            if (Module.FS.analyzePath(processedFilename).exists) {
                                const processedData = Module.FS.readFile(processedFilename);
                                log('å¤„ç†åçš„æ–‡ä»¶å·²ç”Ÿæˆ: ' + processedFilename + ' (å¤§å°: ' + processedData.length + ' bytes)');
                            } else {
                                log('æœªæ‰¾åˆ°å¤„ç†åçš„æ–‡ä»¶: ' + processedFilename);
                            }
                        } catch (fsError) {
                            log('æ£€æŸ¥å¤„ç†åæ–‡ä»¶æ—¶å‡ºé”™: ' + fsError.message);
                        }
                    };
                    reader.readAsArrayBuffer(currentFile);
                } else {
                    log('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå›¾åƒæ–‡ä»¶');
                }
            } catch (error) {
                log('æµ‹è¯• processFile å‡½æ•°æ—¶å‡ºé”™: ' + error.message);
            }
        }
        
        function testCProcessFileWithFile() {
            if (!Module) {
                log('é”™è¯¯: WebAssembly æ¨¡å—å°šæœªåŠ è½½');
                return;
            }
            
            if (!currentFile) {
                log('é”™è¯¯: è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå›¾åƒæ–‡ä»¶');
                return;
            }
            
            try {
                log('=== ä½¿ç”¨ä¸Šä¼ æ–‡ä»¶æµ‹è¯• c_processFile ===');
                log('æ–‡ä»¶ä¿¡æ¯: ' + currentFile.name + ' (' + currentFile.size + ' bytes)');
                
                // æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
                if (!Module.FS) {
                    log('âœ— æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒï¼Œæ— æ³•ä½¿ç”¨ processFile æ¥å£');
                    log('ğŸ’¡ å»ºè®®: ä½¿ç”¨ bar æ¥å£ä»£æ›¿ï¼Œå®ƒä¸éœ€è¦æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ');
                    log('ğŸ’¡ æˆ–è€…é‡æ–°ç¼–è¯‘é¡¹ç›®ä»¥åŒ…å«æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    const uint8Array = new Uint8Array(arrayBuffer);
                    
                    // å†™å…¥è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
                    const filename = '/tmp/' + currentFile.name;
                    
                    try {
                        // ç¡®ä¿ /tmp ç›®å½•å­˜åœ¨
                        if (!Module.FS.analyzePath('/tmp').exists) {
                            Module.FS.mkdir('/tmp');
                            log('âœ“ åˆ›å»º /tmp ç›®å½•');
                        }
                        
                        Module.FS.writeFile(filename, uint8Array);
                        log('âœ“ æ–‡ä»¶å·²å†™å…¥è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ: ' + filename);
                        
                        // è¯¦ç»†éªŒè¯æ–‡ä»¶å†™å…¥
                        if (Module.FS.analyzePath(filename).exists) {
                            log('âœ“ æ–‡ä»¶å­˜åœ¨éªŒè¯æˆåŠŸ');
                            
                            // è¯»å–å¹¶éªŒè¯æ–‡ä»¶å†…å®¹
                            const writtenData = Module.FS.readFile(filename);
                            log('âœ“ æ–‡ä»¶å¤§å°éªŒè¯: ' + writtenData.length + ' bytes (åŸå§‹: ' + uint8Array.length + ' bytes)');
                            
                            // æ£€æŸ¥æ–‡ä»¶å¤´
                            if (writtenData.length >= 4) {
                                const header = [];
                                for (let i = 0; i < Math.min(8, writtenData.length); i++) {
                                    header.push('0x' + writtenData[i].toString(16).padStart(2, '0'));
                                }
                                log('âœ“ æ–‡ä»¶å¤´: ' + header.join(' '));
                                
                                // æ£€æŸ¥å›¾åƒæ ¼å¼
                                if (writtenData[0] === 0x89 && writtenData[1] === 0x50 && writtenData[2] === 0x4E && writtenData[3] === 0x47) {
                                    log('âœ“ æ£€æµ‹åˆ° PNG æ ¼å¼');
                                } else if (writtenData[0] === 0xFF && writtenData[1] === 0xD8) {
                                    log('âœ“ æ£€æµ‹åˆ° JPEG æ ¼å¼');
                                } else if (writtenData[0] === 0x42 && writtenData[1] === 0x4D) {
                                    log('âœ“ æ£€æµ‹åˆ° BMP æ ¼å¼');
                                } else {
                                    log('âš ï¸ æœªè¯†åˆ«çš„å›¾åƒæ ¼å¼ï¼Œå°†å°è¯•å¤„ç†');
                                }
                            }
                            
                            // è°ƒç”¨ c_processFile å‡½æ•°
                            if (Module.ccall) {
                                Module.ccall('c_processFile', null, ['string'], [filename]);
                                log('âœ“ é€šè¿‡ ccall è°ƒç”¨ c_processFile æˆåŠŸ');
                            } else if (Module._c_processFile) {
                                Module._c_processFile(filename);
                                log('âœ“ ç›´æ¥è°ƒç”¨ _c_processFile æˆåŠŸ');
                            } else {
                                log('âœ— c_processFile å‡½æ•°ä¸å¯ç”¨');
                                return;
                            }
                            
                            // æ£€æŸ¥å¤„ç†ç»“æœ
                            setTimeout(() => {
                                const processedFilename = filename + '_processed.png';
                                try {
                                    if (Module.FS.analyzePath(processedFilename).exists) {
                                        const processedData = Module.FS.readFile(processedFilename);
                                        log('âœ“ å¤„ç†æˆåŠŸï¼è¾“å‡ºæ–‡ä»¶: ' + processedFilename + ' (å¤§å°: ' + processedData.length + ' bytes)');
                                        
                                        // åˆ—å‡ºè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶
                                        log('è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶:');
                                        const files = Module.FS.readdir('/tmp');
                                        files.forEach(file => {
                                            if (file !== '.' && file !== '..') {
                                                const path = '/tmp/' + file;
                                                const stat = Module.FS.stat(path);
                                                log('  - ' + file + ' (å¤§å°: ' + stat.size + ' bytes)');
                                            }
                                        });
                                    } else {
                                        log('âœ— æœªæ‰¾åˆ°å¤„ç†åçš„æ–‡ä»¶: ' + processedFilename);
                                    }
                                } catch (checkError) {
                                    log('æ£€æŸ¥å¤„ç†ç»“æœæ—¶å‡ºé”™: ' + checkError.message);
                                }
                            }, 100); // ç»™ä¸€ç‚¹æ—¶é—´è®©å¤„ç†å®Œæˆ
                            
                        } else {
                            log('âœ— æ–‡ä»¶å†™å…¥åéªŒè¯å¤±è´¥');
                        }
                    } catch (fsError) {
                        log('æ–‡ä»¶ç³»ç»Ÿæ“ä½œå¤±è´¥: ' + fsError.message);
                    }
                };
                
                reader.onerror = function() {
                    log('æ–‡ä»¶è¯»å–å¤±è´¥');
                };
                
                reader.readAsArrayBuffer(currentFile);
                
            } catch (error) {
                log('æµ‹è¯• c_processFile æ—¶å‡ºé”™: ' + error.message);
            }
        }
        
        // æ·»åŠ ä¸€ä¸ªä¸ä¾èµ–æ–‡ä»¶ç³»ç»Ÿçš„æµ‹è¯•å‡½æ•°
        function testWithoutFileSystem() {
            if (!Module) {
                log('é”™è¯¯: WebAssembly æ¨¡å—å°šæœªåŠ è½½');
                return;
            }
            
            if (!currentFile) {
                log('é”™è¯¯: è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå›¾åƒæ–‡ä»¶');
                return;
            }
            
            try {
                log('=== ä¸ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæµ‹è¯•å›¾åƒå¤„ç† ===');
                log('æ–‡ä»¶ä¿¡æ¯: ' + currentFile.name + ' (' + currentFile.size + ' bytes)');
                log('æ³¨æ„: ç”±äºæ–‡ä»¶ç³»ç»Ÿä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨ bar æ¥å£è¿›è¡Œæµ‹è¯•');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    const uint8Array = new Uint8Array(arrayBuffer);
                    
                    log('æ–‡ä»¶è¯»å–æˆåŠŸï¼Œæ•°æ®å¤§å°: ' + uint8Array.length + ' bytes');
                    
                    // åˆ†é…å†…å­˜
                    const dataPtr = Module._malloc(uint8Array.length);
                    if (!dataPtr) {
                        log('âœ— å†…å­˜åˆ†é…å¤±è´¥');
                        return;
                    }
                    
                    log('âœ“ å†…å­˜åˆ†é…æˆåŠŸï¼Œåœ°å€: ' + dataPtr);
                    
                    try {
                        // å¤åˆ¶æ•°æ®åˆ°WASMå†…å­˜
                        Module.HEAPU8.set(uint8Array, dataPtr);
                        log('âœ“ æ•°æ®å·²å¤åˆ¶åˆ°WASMå†…å­˜');
                        
                        // å°è¯•ä¸åŒçš„è°ƒç”¨æ–¹å¼
                        let success = false;
                        
                        // 1. å°è¯•ç»‘å®šçš„ bar å‡½æ•°
                        if (Module.bar && typeof Module.bar === 'function') {
                            try {
                                Module.bar(dataPtr, uint8Array.length);
                                log('âœ“ ç»‘å®š bar å‡½æ•°è°ƒç”¨æˆåŠŸ');
                                success = true;
                            } catch (error) {
                                log('âœ— ç»‘å®š bar å‡½æ•°è°ƒç”¨å¤±è´¥: ' + error.message);
                            }
                        }
                        
                        // 2. å°è¯• C é£æ ¼çš„ c_bar å‡½æ•°
                        if (!success && Module._c_bar) {
                            try {
                                Module._c_bar(dataPtr, uint8Array.length);
                                log('âœ“ C é£æ ¼ c_bar å‡½æ•°è°ƒç”¨æˆåŠŸ');
                                success = true;
                            } catch (error) {
                                log('âœ— C é£æ ¼ c_bar å‡½æ•°è°ƒç”¨å¤±è´¥: ' + error.message);
                            }
                        }
                        
                        // 3. å°è¯•é€šè¿‡ ccall è°ƒç”¨
                        if (!success && Module.ccall) {
                            try {
                                Module.ccall('c_bar', null, ['number', 'number'], [dataPtr, uint8Array.length]);
                                log('âœ“ ccall c_bar å‡½æ•°è°ƒç”¨æˆåŠŸ');
                                success = true;
                            } catch (error) {
                                log('âœ— ccall c_bar å‡½æ•°è°ƒç”¨å¤±è´¥: ' + error.message);
                            }
                        }
                        
                        if (!success) {
                            log('âœ— æ‰€æœ‰ bar å‡½æ•°è°ƒç”¨æ–¹å¼éƒ½å¤±è´¥äº†');
                            log('å¯èƒ½çš„åŸå› :');
                            log('  - å‡½æ•°æ²¡æœ‰æ­£ç¡®å¯¼å‡º');
                            log('  - ç¼–è¯‘æ—¶å‡ºç°é—®é¢˜');
                            log('  - å‡½æ•°ç­¾åä¸åŒ¹é…');
                        }
                        
                    } finally {
                        // é‡Šæ”¾å†…å­˜
                        Module._free(dataPtr);
                        log('âœ“ å†…å­˜å·²é‡Šæ”¾');
                    }
                };
                
                reader.onerror = function() {
                    log('âœ— æ–‡ä»¶è¯»å–å¤±è´¥');
                };
                
                reader.readAsArrayBuffer(currentFile);
                
            } catch (error) {
                log('æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message);
            }
        }
        
        function testAllInterfaces() {
            if (!Module) {
                log('é”™è¯¯: WebAssembly æ¨¡å—å°šæœªåŠ è½½');
                return;
            }
            
            log('=== å¼€å§‹æµ‹è¯•æ‰€æœ‰æ¥å£ ===');
            log('æ—¶é—´: ' + new Date().toLocaleString());
            log('');
            
            // 1. æµ‹è¯•åŸºæœ¬çš„å¯¼å‡ºå‡½æ•°
            log('1. æ£€æŸ¥åŸºæœ¬å¯¼å‡ºå‡½æ•°:');
            const basicFunctions = ['_main', '_malloc', '_free', 'ccall', 'cwrap'];
            basicFunctions.forEach(funcName => {
                if (Module[funcName]) {
                    log('  âœ“ ' + funcName + ' - å¯ç”¨');
                } else {
                    log('  âœ— ' + funcName + ' - ä¸å¯ç”¨');
                }
            });
            log('');
            
            // 2. æµ‹è¯•è‡ªå®šä¹‰å¯¼å‡ºå‡½æ•°
            log('2. æ£€æŸ¥è‡ªå®šä¹‰å¯¼å‡ºå‡½æ•°:');
            const customFunctions = ['_c_foo', '_c_bar', '_c_processFile', 'foo', 'bar', 'processFile'];
            customFunctions.forEach(funcName => {
                if (Module[funcName]) {
                    log('  âœ“ ' + funcName + ' - å¯ç”¨');
                } else {
                    log('  âœ— ' + funcName + ' - ä¸å¯ç”¨');
                }
            });
            log('');
            
            // 3. æµ‹è¯•å†…å­˜åˆ†é…å’Œé‡Šæ”¾
            log('3. æµ‹è¯•å†…å­˜ç®¡ç†:');
            try {
                const testSize = 1024;
                const ptr = Module._malloc(testSize);
                if (ptr && ptr !== 0) {
                    log('  âœ“ å†…å­˜åˆ†é…æˆåŠŸ (åœ°å€: ' + ptr + ')');
                    Module._free(ptr);
                    log('  âœ“ å†…å­˜é‡Šæ”¾æˆåŠŸ');
                } else {
                    log('  âœ— å†…å­˜åˆ†é…å¤±è´¥');
                }
            } catch (error) {
                log('  âœ— å†…å­˜ç®¡ç†æµ‹è¯•å¤±è´¥: ' + error.message);
            }
            log('');
            
            // 4. æµ‹è¯• C é£æ ¼å‡½æ•°è°ƒç”¨
            log('4. æµ‹è¯• C é£æ ¼å‡½æ•°è°ƒç”¨:');
            if (Module._c_foo && Module._malloc && Module._free) {
                try {
                    const width = 100, height = 100, channels = 3;
                    const dataSize = width * height * channels;
                    const dataPtr = Module._malloc(dataSize);
                    
                    // ä½¿ç”¨ ccall è°ƒç”¨
                    if (Module.ccall) {
                        Module.ccall('c_foo', null, ['number', 'number', 'number', 'number'], 
                                   [dataPtr, width, height, channels]);
                        log('  âœ“ ccall è°ƒç”¨ c_foo æˆåŠŸ');
                    }
                    
                    // ç›´æ¥è°ƒç”¨
                    Module._c_foo(dataPtr, width, height, channels);
                    log('  âœ“ ç›´æ¥è°ƒç”¨ _c_foo æˆåŠŸ');
                    
                    Module._free(dataPtr);
                    log('  âœ“ å‚æ•°: width=' + width + ', height=' + height + ', channels=' + channels);
                } catch (error) {
                    log('  âœ— C å‡½æ•°è°ƒç”¨å¤±è´¥: ' + error.message);
                }
            } else {
                log('  âœ— C å‡½æ•°ä¸å¯ç”¨');
            }
            log('');
            
            // 5. æµ‹è¯•ç»‘å®šå‡½æ•°ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            log('5. æµ‹è¯• Emscripten ç»‘å®šå‡½æ•°:');
            if (Module.foo && typeof Module.foo === 'function') {
                try {
                    const width = 200, height = 150, channels = 4;
                    const dataSize = width * height * channels;
                    const dataPtr = Module._malloc(dataSize);
                    
                    Module.foo(dataPtr, width, height, channels);
                    Module._free(dataPtr);
                    log('  âœ“ ç»‘å®šå‡½æ•° foo è°ƒç”¨æˆåŠŸ');
                    log('  âœ“ å‚æ•°: width=' + width + ', height=' + height + ', channels=' + channels);
                } catch (error) {
                    log('  âœ— ç»‘å®šå‡½æ•°è°ƒç”¨å¤±è´¥: ' + error.message);
                }
            } else {
                log('  â—‹ ç»‘å®šå‡½æ•°ä¸å¯ç”¨ (è¿™æ˜¯æ­£å¸¸çš„)');
            }
            log('');
            
            // 6. æ€§èƒ½æµ‹è¯•
            log('6. ç®€å•æ€§èƒ½æµ‹è¯•:');
            if (Module._c_foo && Module._malloc && Module._free) {
                try {
                    const testCount = 1000;
                    const startTime = performance.now();
                    
                    for (let i = 0; i < testCount; i++) {
                        const dataPtr = Module._malloc(100);
                        Module._c_foo(dataPtr, 10, 10, 1);
                        Module._free(dataPtr);
                    }
                    
                    const endTime = performance.now();
                    const totalTime = endTime - startTime;
                    const avgTime = totalTime / testCount;
                    
                    log('  âœ“ æ‰§è¡Œ ' + testCount + ' æ¬¡è°ƒç”¨');
                    log('  âœ“ æ€»æ—¶é—´: ' + totalTime.toFixed(2) + ' ms');
                    log('  âœ“ å¹³å‡æ—¶é—´: ' + avgTime.toFixed(4) + ' ms/æ¬¡');
                } catch (error) {
                    log('  âœ— æ€§èƒ½æµ‹è¯•å¤±è´¥: ' + error.message);
                }
            } else {
                log('  âœ— æ— æ³•è¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Œå‡½æ•°ä¸å¯ç”¨');
            }
            log('');
            
            // 7. æµ‹è¯•æ–°å¢çš„æ¥å£
            log('7. æµ‹è¯•æ–°å¢æ¥å£:');
            
            // æµ‹è¯• bar å‡½æ•°
            if (Module._c_bar && Module._malloc && Module._free) {
                try {
                    const testDataSize = 100;
                    const dataPtr = Module._malloc(testDataSize);
                    
                    // é€šè¿‡ ccall è°ƒç”¨
                    if (Module.ccall) {
                        Module.ccall('c_bar', null, ['number', 'number'], [dataPtr, testDataSize]);
                        log('  âœ“ c_bar å‡½æ•°æµ‹è¯•æˆåŠŸ (ccall)');
                    }
                    
                    // ç›´æ¥è°ƒç”¨
                    Module._c_bar(dataPtr, testDataSize);
                    log('  âœ“ c_bar å‡½æ•°æµ‹è¯•æˆåŠŸ (ç›´æ¥è°ƒç”¨)');
                    
                    Module._free(dataPtr);
                } catch (error) {
                    log('  âœ— c_bar å‡½æ•°æµ‹è¯•å¤±è´¥: ' + error.message);
                }
            } else {
                log('  â—‹ c_bar å‡½æ•°ä¸å¯ç”¨');
            }
            
            // æµ‹è¯• processFile å‡½æ•°
            if (Module._c_processFile) {
                try {
                    // åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶åœ¨è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸­
                    const testData = new Uint8Array([0x89, 0x50, 0x4E, 0x47]); // PNG å¤´éƒ¨
                    Module.FS.writeFile('/tmp/test.png', testData);
                    
                    if (Module.ccall) {
                        Module.ccall('c_processFile', null, ['string'], ['/tmp/test.png']);
                        log('  âœ“ c_processFile å‡½æ•°æµ‹è¯•æˆåŠŸ (ccall)');
                    }
                    
                    Module._c_processFile('/tmp/test.png');
                    log('  âœ“ c_processFile å‡½æ•°æµ‹è¯•æˆåŠŸ (ç›´æ¥è°ƒç”¨)');
                } catch (error) {
                    log('  âœ— c_processFile å‡½æ•°æµ‹è¯•å¤±è´¥: ' + error.message);
                }
            } else {
                log('  â—‹ c_processFile å‡½æ•°ä¸å¯ç”¨');
            }
            
            log('');
            
            log('=== æ¥å£æµ‹è¯•å®Œæˆ ===');
            log('æµ‹è¯•æ—¶é—´: ' + new Date().toLocaleString());
            
            if (currentFile) {
                log('');
                log('ğŸ’¡ æç¤º: æ£€æµ‹åˆ°å·²é€‰æ‹©æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨"ä½¿ç”¨ä¸Šä¼ æ–‡ä»¶æµ‹è¯• c_processFile"æŒ‰é’®è¿›è¡Œæ–‡ä»¶å¤„ç†æµ‹è¯•');
            }
        }
        
        // åŠ è½½ WebAssembly æ¨¡å—
        log('æ­£åœ¨åŠ è½½ WebAssembly æ¨¡å—...');
        
        // åŠ è½½è„šæœ¬
        const script = document.createElement('script');
        script.src = 'dist/opencv-wasm-demo.js';
        script.onload = function() {
            log('JavaScript è„šæœ¬åŠ è½½æˆåŠŸ');
            
            // æ£€æŸ¥OpenCVModuleæ˜¯å¦å¯ç”¨
            if (typeof OpenCVModule === 'function') {
                log('OpenCVModule å‡½æ•°å¯ç”¨ï¼Œå¼€å§‹åˆå§‹åŒ–...');
                
                // æ¨¡å—é…ç½®
                const moduleConfig = {
                    onRuntimeInitialized: function() {
                        Module = this;
                        log('WebAssembly æ¨¡å—åŠ è½½æˆåŠŸï¼');
                        log('å¯ç”¨çš„å¯¼å‡ºå‡½æ•°:');
                        
                        // åˆ—å‡ºä¸€äº›å…³é”®çš„å¯¼å‡ºå‡½æ•°
                        const exports = ['_main', '_c_foo', '_c_bar', '_c_processFile', '_malloc', '_free', 'ccall', 'cwrap'];
                        exports.forEach(name => {
                            if (Module[name]) {
                                log('  âœ“ ' + name);
                            } else {
                                log('  âœ— ' + name + ' (ä¸å¯ç”¨)');
                            }
                        });
                        
                        // æ£€æŸ¥ç»‘å®šå‡½æ•°
                        const bindingFunctions = ['foo', 'bar', 'processFile'];
                        bindingFunctions.forEach(name => {
                            if (Module[name]) {
                                log('  âœ“ ' + name + ' (ç»‘å®šå‡½æ•°)');
                            } else {
                                log('  âœ— ' + name + ' (ç»‘å®šå‡½æ•°ä¸å¯ç”¨)');
                            }
                        });
                        
                        // æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
                        if (Module.FS) {
                            log('  âœ“ FS (æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ)');
                            
                            // åˆ›å»ºä¸´æ—¶ç›®å½•
                            try {
                                if (!Module.FS.analyzePath('/tmp').exists) {
                                    Module.FS.mkdir('/tmp');
                                    log('  âœ“ åˆ›å»º /tmp ç›®å½•æˆåŠŸ');
                                } else {
                                    log('  âœ“ /tmp ç›®å½•å·²å­˜åœ¨');
                                }
                            } catch (e) {
                                log('  âš  åˆ›å»º /tmp ç›®å½•å¤±è´¥: ' + e.message);
                            }
                        } else {
                            log('  âœ— FS (æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒ) - éœ€è¦é‡æ–°ç¼–è¯‘');
                        }
                        
                        log('\nç°åœ¨å¯ä»¥æµ‹è¯•å‡½æ•°äº†ï¼');
                        enableButtons();
                    },
                    print: function(text) {
                        log('WASMè¾“å‡º: ' + text);
                    },
                    printErr: function(text) {
                        log('WASMé”™è¯¯: ' + text);
                    }
                };
                
                // åˆå§‹åŒ–æ¨¡å—
                OpenCVModule(moduleConfig).then(function(module) {
                    log('æ¨¡å—åˆå§‹åŒ–å®Œæˆ');
                }).catch(function(error) {
                    log('æ¨¡å—åˆå§‹åŒ–å¤±è´¥: ' + error);
                });
                
            } else {
                log('é”™è¯¯: OpenCVModule å‡½æ•°ä¸å¯ç”¨');
                log('ç”Ÿæˆçš„JSæ–‡ä»¶å¯èƒ½æœ‰é—®é¢˜');
            }
        };
        script.onerror = function() {
            log('é”™è¯¯: æ— æ³•åŠ è½½ WebAssembly è„šæœ¬æ–‡ä»¶');
            log('è¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œå¹¶ä¸”æ–‡ä»¶è·¯å¾„æ­£ç¡®');
            log('å½“å‰URL: ' + window.location.href);
            log('å°è¯•è®¿é—®: ' + window.location.origin + '/dist/opencv-wasm-demo.js');
        };
        document.head.appendChild(script);
    </script>
</body>
</html> 