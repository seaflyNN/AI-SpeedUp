cmake_minimum_required(VERSION 3.25)

project(ImageProcess VERSION 1.0)

if(MSVC)
  set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>")
endif()

include(CTest)
enable_testing()

set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# è®¾ç½®æ„å»ºç±»å‹ä¸ºDebugï¼Œå¹¶é™åˆ¶é…ç½®ç±»å‹
set(CMAKE_BUILD_TYPE Debug)
set(CMAKE_CONFIGURATION_TYPES "Debug" CACHE STRING "é™åˆ¶æ„å»ºé…ç½®" FORCE)

# è®¾ç½® OpenCV æºç å’Œå®‰è£…ç›®å½•
set(OpenCV_SOURCE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/3rd/opencv-4.10.0")
set(OpenCV_INSTALL_DIR "${CMAKE_CURRENT_SOURCE_DIR}/3rd/install")

include(cmake/opencv-cmake-option.cmake)

# è®¾ç½® OpenCV æ„å»ºç›®å½•
set(OpenCV_BUILD_DIR "${CMAKE_BINARY_DIR}/opencv_build")

message("---->${OpenCV_CMAKE_ARGS}")

# ä½¿ç”¨ ExternalProject æ¥è‡ªåŠ¨æ„å»º OpenCV
include(ExternalProject)

ExternalProject_Add(
    OpenCV
    PREFIX ${OpenCV_BUILD_DIR}
    SOURCE_DIR ${OpenCV_SOURCE_DIR}
    CMAKE_ARGS -DCMAKE_INSTALL_PREFIX=${OpenCV_INSTALL_DIR}
               -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
               ${OpenCV_CMAKE_ARGS}
    INSTALL_DIR ${OpenCV_INSTALL_DIR}
)

# æ–¹æ¡ˆ2ï¼šä¸¤é˜¶æ®µç¼–è¯‘
# è®¾ç½®æ­£ç¡®çš„OpenCVè·¯å¾„ï¼ˆæŒ‡å‘é™æ€åº“ç›®å½•ï¼‰
set(OpenCV_DIR "${OpenCV_INSTALL_DIR}/x64/vc17/staticlib")

# æ£€æŸ¥æ˜¯å¦ä¸ºç¬¬ä¸€é˜¶æ®µæ„å»ºï¼ˆåªæ„å»ºOpenCVï¼‰
if(DEFINED BUILDING_OPENCV_ONLY)
    message(STATUS "ğŸ”§ ç¬¬ä¸€é˜¶æ®µï¼šä»…æ„å»ºOpenCV...")
    # ç¬¬ä¸€é˜¶æ®µä¸æ‰§è¡Œåç»­çš„find_packageå’Œä¸»é¡¹ç›®é…ç½®
    return()
endif()

# æ£€æŸ¥OpenCVæ˜¯å¦å·²ç»æ­£ç¡®æ„å»ºå®Œæˆ
set(OpenCV_STATIC_LIB_DIR "${OpenCV_INSTALL_DIR}/x64/vc17/staticlib")
if(NOT EXISTS "${OpenCV_DIR}/OpenCVConfig.cmake" OR NOT EXISTS "${OpenCV_STATIC_LIB_DIR}")
    message("")
    message("============================================================")
    message("ğŸ”§ OpenCVå°šæœªæ„å»ºæˆ–æ„å»ºä¸å®Œæ•´ï¼")
    message("")
    message("è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œä¸¤é˜¶æ®µç¼–è¯‘ï¼š")
    message("")
    message("ğŸ“‹ æ­¥éª¤1ï¼šå…ˆæ¸…ç†å¹¶æ„å»ºOpenCV")
    message("   rd /s /q build")
    message("   rd /s /q 3rd\\install")
    message("   cmake -S . -B build -DBUILDING_OPENCV_ONLY=ON")
    message("   cmake --build build --target OpenCV")
    message("")
    message("ğŸ“‹ æ­¥éª¤2ï¼šé‡æ–°é…ç½®å¹¶æ„å»ºä¸»é¡¹ç›®") 
    message("   cmake -S . -B build")
    message("   cmake --build build")
    message("")
    message("ğŸ’¡ æç¤ºï¼šæˆ–è€…ç›´æ¥è¿è¡Œ build.bat è„šæœ¬")
    message("============================================================")
    message("")
    message(FATAL_ERROR "è¯·å…ˆæ„å»ºOpenCVï¼Œç„¶åé‡æ–°è¿è¡Œcmakeé…ç½®")
endif()

message("===============================================")
# OpenCVå·²æ„å»ºï¼Œä½¿ç”¨æ ‡å‡†find_package
find_package(OpenCV REQUIRED)

message(STATUS "âœ… æ‰¾åˆ°OpenCVç‰ˆæœ¬: ${OpenCV_VERSION}")
message(STATUS "   åº“æ–‡ä»¶: ${OpenCV_LIBS}")
message(STATUS "   åŒ…å«ç›®å½•: ${OpenCV_INCLUDE_DIRS}")
message(STATUS "   é…ç½®æ–‡ä»¶: ${OpenCV_DIR}/OpenCVConfig.cmake")

# æ·»åŠ ä¸»é¡¹ç›®çš„æºæ–‡ä»¶
add_subdirectory(src)
